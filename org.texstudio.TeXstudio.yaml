app-id: org.texstudio.TeXstudio
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk
add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    directory: texlive
    subdirectories: true
    autodelete: true
    version: '24.08'
    no-autodownload: true
  org.texstudio.TeXstudio.Extension.ngrams:
    directory: ngrams
    subdirectories: true
    autodelete: true
    no-autodownload: true
command: texstudio.sh
rename-icon: texstudio
rename-appdata-file: texstudio.metainfo.xml
rename-desktop-file: texstudio.desktop
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --share=network # required for template repository. Does not interfere with LanguageTool, which is now accessible on the host as well
  - --device=dri
  # filesystem access: required e.g. for \include, \input or \includegraphics
  - --filesystem=host
  - --filesystem=/tmp # this way lualatex etc. can access files newly ceated by TeXstudio stored in the hosts's /tmp
  - --talk-name=org.freedesktop.Flatpak # required for flatpak-spawn --host
  - --talk-name=com.canonical.AppMenu.Registrar # required for global menu
  - --env=PATH=/usr/bin:/app/bin:/app/texlive/bin:/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux:/app/jre/bin # add paths of TeXlive Flatpak extension binaries
  - --env=LD_LIBRARY_PATH=/app/texlive/lib/ # add library paths
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
modules:
  - name: extension-points
    buildsystem: simple
    build-commands:
      - mkdir /app/texlive
      - mkdir ${FLATPAK_DEST}/ngrams # intended for https://github.com/flathub/flathub/pull/4446

  - name: poppler # build dependency of TeXstudio
    buildsystem: cmake-ninja
    config-opts: # for command line switches, cf. CMakeLists.txt
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_GTK_TESTS=OFF
      - -DBUILD_QT5_TESTS=OFF
      - -DBUILD_QT6_TESTS=OFF
      - -DBUILD_CPP_TESTS=OFF
      - -DBUILD_MANUAL_TESTS=OFF
      - -DENABLE_GLIB=OFF
      - -DENABLE_QT5=OFF
      - -DENABLE_LIBCURL=OFF
      - -DENABLE_GPGME=OFF
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-25.10.0.tar.xz
        sha256: 6b5e9bb64dabb15787a14db1675291c7afaf9387438cc93a4fb7f6aec4ee6fe0
        x-checker-data:
          type: anitya
          project-id: 3686
          url-template: https://poppler.freedesktop.org/poppler-$version.tar.xz
    modules:
      - name: poppler-data # required to properly display CJK chars in PDF viewer
        buildsystem: cmake-ninja
        builddir: true
        config-opts:
          - -DCMAKE_BUILD_TYPE:STRING=RelWithDebInfo
        sources:
          - type: archive
            url: https://poppler.freedesktop.org/poppler-data-0.4.12.tar.gz
            sha256: c835b640a40ce357e1b83666aabd95edffa24ddddd49b8daff63adb851cdab74
            x-checker-data:
              type: anitya
              project-id: 3687
              url-template: https://poppler.freedesktop.org/poppler-data-$version.tar.gz
        post-install:
          - install -p -D -m 0644 ../COPYING* -t "${FLATPAK_DEST}/share/licenses/poppler-data/";
      - name: boost
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh --prefix=/app --with-libraries=system
          - ./b2 -j $FLATPAK_BUILDER_N_JOBS install
        sources:
          - type: archive
            url: https://archives.boost.io/release/1.89.0/source/boost_1_89_0.tar.gz
            sha256: 9de758db755e8330a01d995b0a24d09798048400ac25c03fc5ea9be364b13c93
            x-checker-data:
              type: anitya
              project-id: 6845
              url-template: https://archives.boost.io/release/$version/source/boost_${version0}_${version1}_${version2}.tar.gz

  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk/install.sh

  - name: languagetool
    buildsystem: simple
    build-commands:
      - mkdir /app/languagetool
      - cp -r * /app/languagetool
    sources:
      - url: https://languagetool.org/download/LanguageTool-6.6.zip
        type: archive
        sha256: 53600506b399bb5ffe1e4c8dec794fd378212f14aaf38ccef9b6f89314d11631
        x-checker-data:
          type: anitya
          project-id: 241970
          url-template: https://languagetool.org/download/LanguageTool-$version.zip

  - name: pandoc
    buildsystem: simple
    build-commands:
      - install -D bin/pandoc /app/bin/pandoc
    # pandoc is only needed for converting the changelog
    cleanup:
      - '*'
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/jgm/pandoc/releases/download/3.8.2/pandoc-3.8.2-linux-amd64.tar.gz
        sha256: 3252c5fd8234925f46973f4f17f852ccda64777a0c631d5735861c7eb4d69132
        x-checker-data:
          type: anitya
          project-id: 2589
          url-template: https://github.com/jgm/pandoc/releases/download/$version/pandoc-$version-linux-amd64.tar.gz
      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/jgm/pandoc/releases/download/3.8.2/pandoc-3.8.2-linux-arm64.tar.gz
        sha256: 898b5c1f6bcab8a60253cca1027e43476efa22d1ce99232bb958cd11803bcb90
        x-checker-data:
          type: anitya
          project-id: 2589
          url-template: https://github.com/jgm/pandoc/releases/download/$version/pandoc-$version-linux-arm64.tar.gz

  - name: texstudio
    buildsystem: cmake-ninja
    config-opts:
      - -Wno-dev
    cleanup-platform:
      - /bin
      - /mkspecs
    sources:
      - type: git
        url: https://github.com/texstudio-org/texstudio.git
        tag: 4.8.9
        commit: cdcfa788931a4397f23b328173ae29272d450f1a
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
      - type: file
        path: changelog2metainfo.sh
      - type: file
        path: texstudio.sh
      - type: shell
        commands:
          - sed -e "s|setDesktopFileName(\"texstudio\")|setDesktopFileName(\"org.texstudio.TeXstudio\")|"
            -i src/main.cpp
          - desktop-file-edit --set-key=Exec --set-value="texstudio.sh %F" utilities/texstudio.desktop
          - chmod +x ./changelog2metainfo.sh && ./changelog2metainfo.sh
          - sed -zi "s|</description>[[:space:]]*<launchable|<p>Requires either TeX
            Live being installed on the system from your distribution's repositories
            or the TeX Live Flatpak which you can install by running 'flatpak install
            flathub org\.freedesktop\.Sdk\.Extension\.texlive//24\.08'</p></description><launchable|"
            utilities/texstudio.metainfo.xml
    build-commands:
      - install -Dm755 -t ${FLATPAK_DEST}/bin/ ./texstudio.sh
